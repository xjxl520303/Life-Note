---
created_at: 2024-07-11 19:29:50
tags:
  - Codemirror
updated_at: 2024-07-16 19:44:19
---
本文以文本编辑器中一个比较常见的【下划线】功能为聚焦点来探讨一下一个小小的功能在各大笔记应用中的细节。我们以小见大、精益求精，从一个非常小的细节来看这些笔记应用（作者主要以网页版作为测评）对于功能上的打磨程度，用户体验如何。

最近几个月一直在写 Obsidian 一些重要的插件（如：Dataview，Templater,……）使用教程。在写作的过程中自己也尝试过很多插件，发现有的插件很不错可惜作者已不再维护或者说归档了——于是就开始自己去了解一些插件开发的知识。

在 Obsidian 的插件开发文档中有关**编辑器**扩展的部分文档提到了使用 Codemirror 来创建视图，还提到了很多以前没有接触过的 “State Field”、“Decorations”和“State Effect”概念。但是看了 Obsidian 的文档还是一知半解，不知道如何入手，同时通过搜索引擎查阅 Codemirror 6 相关的文章也寥寥无几，只好跟着 Codemirror 官方[示例](https://codemirror.net/examples/)来了解相关的知识。

本文不去解释有关 **State**、**Effect** 和 **Decoration** 的概念——因为写这篇文章时还处于懵懂状态，就不误导人了。文章主要是基于官方示例([Example: Decorations](https://codemirror.net/examples/decoration/))中有关 Mark Decoration 的使用进行思考和扩展，并使用 React（并不依赖于它） 来实现。

## 高能预警

因为作者现阶段只是了解了一点 Codemirror 的知识，所以文章也就局限在对通过 `Decoration.mark` 添加下划线和去除下划线的一些特殊场景的思考上，代码实现并不据有实际应用性（仅作思路参考）。目前作者还不知道如何保存操作后的结果，以及加载已标记过的内容——特别是在 Obsidian 中保存操作的结果以及获取标记后的 HTML 原始内容——希望哪位大神能指点一二。
## 主流笔记应用对下划线功能的支持程度测评

接下来我们以二段简单地，分别包含中英文的文字来作为测试样例文本：

```
基于 IKAnalyzer 字典分词器的 node.js 实现。
Lorem ipsum dolor sit amet, consectetur adipisicing elit
```

我们选取主流的几款笔记应用并设计几个测试用例点来看一下各个笔记应用地表现。

- 印象笔记
- 有道云笔记
- 语雀
- Notion
- Obsidian

测试功能主要为：

1. 对于中英文选词的支持程度（测试点：光标位于词语/单词的位置〔头、中间和尾〕、选区）
2. 如何添加和取消下划线。
3. 如何扩展、缩小下划线的范围（基于单个、多个组合在一起）。
4. 下划线的展现和编辑方式。

>注：后续我们以“「用例➊」”的形式来分别引用上述几个测试功能点。

「用例➌」我们将其分成以下几个小的分类（蓝色框表示接下来操作选中的选区）：

![[Pasted image 20240716161253.png]]

### 印象笔记

对于「用例➊」，印象笔记在选词上支持中英文在光标前后选词。以“下划线”为例：光标位于“下”前面则选中整个词语,在“线”后面同样如此，但是如果在“线”后面出现别的文本（包含空格）只会向右选择。在中文分词上，当光标位于“分词器”的“分”前面只能选中“分词”，无法选中整个词语（这个跟使用的分词词典有关，语料库越丰富就能识别更多的词语）。印象笔记在选中英文单词时会包含右侧的单词分隔符（空格），对于中文同样支持（多个空格也会选中）。

对于「用例➋」，印象笔记支持通过【工具栏】和【快捷键（<kbd>Ctrl+U</kbd>）】来操作。

接下来我们来重点看一下「用例➌」的测试结果：

![[Pasted image 20240716162503.png]]

- 图中 1）通过查看浏览器的开发者工具，会发现合并后的下划线区域文本是分开的 `"amet, "` 和 `"consectetur"` 合在一起后会变成 `"amet, "\n"consectetur"` （其中 `\n` 表示换行），而不是合并后的 `"amet, consectetur"`。
- 图中 2）这个操作可能不太符合作者的认知（如果自己设计应该是合并操作才对）。
- 图中 3）符合期望。
- 图中 4）符合期望，成功取消了单词内部部分字符的下划线。
- 图中 5、6）符合期望，成功合并在一起了，并且单词也没有被分隔成二段。
- 图中 7）应该执行合并操作才对。
- 图中 8）符合期望，成功合并了。
- 图中 9）成功取消了，但是单词前后的空格中的下划线并没有去除掉。

对于「用例➍」，印象笔记是可以通过鼠标任意选中的，编辑器内部显示为：

```html
<span style="text-decoration: underline;" data-mce-style="text-decoration: underline;">amet, consectetur</span>
```

从代码中的 `data-mce-style` 可以看出印象笔记使用了 [TonyMCE](https://github.com/tinymce/tinymce) 文本编辑器。

### 有道云笔记

对于「用例➊」，功能几乎同印象笔记一致，但是不支持单词尾部选择词语/单词——直接选中了整行文本——这或许是为了方便用户选中整行文本（用户体验优化）。在鼠标快速【双击】选中词语/单词上不包含右侧的空格，这一点作者看来更符合操作习惯。

对于「用例➋」两者支持程度也一致。

对于「用例➌」，两者是否有大的差异呢？请看结果：

![[Pasted image 20240716171530.png]]

测试结果让作者很满意（与自己的认识高度一致），只不过在最后一种单词在句中取消下划线时是否连同单词左右的空格一同去除有所差异。通过查看开发者工具中的文本合并情况，会发现并没有出现像印象笔记那样表现不致的地方，表现很完美。

「用例➍」表现和印象笔记一致，其内部表示为：

```html
<span class="underline" style="text-decoration: underline;">consectetur</span>
```

有道云的文本编辑器是自己实现的，具体可参考：

- [前端 - 有道云笔记新版编辑器架构设计（上） - 有道技术团队 - SegmentFault 思否](https://segmentfault.com/a/1190000039046174)
- [前端 - 有道云笔记新版编辑器架构设计（下） - 有道技术团队 - SegmentFault 思否](https://segmentfault.com/a/1190000039104198)

### 语雀

对于「用例➊」和有道云笔记几乎一致，除了在行末【双击】鼠标时不既不选中鼠标前的文本，也不选中整行——主打一个不响应。

对于「用例➋」支持程度一致。

同有道云笔记——都是自研的文本编辑器，对于「用例➌」是否有不同的想法呢？谜底揭晓：

![[Pasted image 20240716174920.png]]

结果居然和印象笔记出奇地一致，难道语雀自研时参考了 TonyMCE 编辑器😂？不过在合并细节处理上和有道云笔记一样保持了统一。

「用例➍」结果为：

```html
<ne-text ne-underline="true" id="u410ac03c">consecte</ne-text>
```

单从代码来看语雀的实现更加现代化和简洁。

有关语雀文本编辑器的介绍可以参考：[语雀编辑器自研之路 - 掘金 (juejin.cn)](https://juejin.cn/post/7036551063498915877)

### Notion

对于「用例➊」，Notion 在选择词语/单词时与印象笔记保持一致（会选中后面的空格）；在行末【双击】时和语雀保持一致。

对于「用例➋」支持程度一致。

对于「用例➌」，Notion 和有道云笔记保持一致。

![[Pasted image 20240716182854.png]]

「用例➍」结果为：

```html
<span style="color:inherit;border-bottom:0.05em solid;word-wrap:break-word" data-token-index="1" class="notion-enable-hover">amet, consectetur </span>
```

从代码中可以看出 Notion 使用了下边框来实现下划线，并未使用 `text-decoration: underline;`。

### Obsidian

Obsidian 很遗憾在这方面支持有点差强人意，本身没有提供添加下划线的功能，但我们可以通过在编辑器中直接输入 `<u>文本</u>` 来实现。

想要通过工具栏来实现添加下划线，我们需要使用由 PKMer 社区开发的 [Editing Toolbar](https://github.com/PKM-er/obsidian-editing-toolbar) 来实现：

![[Pasted image 20240716190032.png]]

对于快捷键我们可以为 Editing Toolbar 提供的命令【Editing Toolbar: Toggle underline】添加快捷键来实现，但是……其功能就……一言难尽了。

![[动画2 68.gif]]

可以看到操作起来并不顺畅，只能应对简单的场景。取消下划线时需要进入标签内部才能取消，好在在分词方面因为有插件 [Word Splitting for Simplified Chinese in Edit Mode and Vim Mode](https://github.com/aidenlx/cm-chs-patch) 稍微找点安慰🤔。

---

行文至此，作者发现对于在浏览器中【双击】选中文本时的分词功能可能是浏览器提供的，与这几个编辑器无关。在选中词语/单词上文本右侧的空格也是浏览器的默认行为。

此外，作者还看了一下知乎的文本编辑器对于下划线的支持情况——同印象笔记和语雀保持一致。

总的说来在处理下划线的场景下可以分为两派：

- 印象笔记、语雀和知乎
- 有道云笔记、Notion

分歧点在于：已添加下划线的文本右侧再次选中别的文本时，是将其作为下划线部分合并还是将重叠部分去除掉。

如果按照用户体验度排名，本次测评结果排名为：**Notion > 有道云笔记、语雀 > 印象笔记 > Obsidian**。

虽然 Obsidian 垫底，但是凭借其强大地开源社区插件生态，相信未来会弥补这一功能上的不足。

